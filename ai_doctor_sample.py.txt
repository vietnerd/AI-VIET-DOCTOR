import streamlit as st
import google.generativeai as genai
from gtts import gTTS
import os
import re
import time

# --- Cáº¤U HÃŒNH ---
# THAY API KEY Cá»¦A Báº N VÃ€O ÄÃ‚Y
os.environ["GOOGLE_API_KEY"] = "gen-lang-client-0132750261"
genai.configure(api_key=os.environ["GOOGLE_API_KEY"])

# --- Cáº¤U HÃŒNH TRANG (MOBILE VIEW) ---
st.set_page_config(page_title="AI Doctor", page_icon="ğŸ¥", layout="centered")

# CSS Ä‘á»ƒ giao diá»‡n giá»‘ng App Ä‘iá»‡n thoáº¡i
st.markdown("""
<style>
    .stChatMessage {border-radius: 15px; padding: 10px;}
    .stTextInput {position: fixed; bottom: 0; width: 100%; z-index: 1000; background: white;}
    .action-box {background-color: #222; color: #00ff00; padding: 10px; border-radius: 5px; font-family: monospace; font-size: 12px; margin-top: 5px;}
</style>
""", unsafe_allow_html=True)

# --- LOGIC AI ---
SYSTEM_PROMPT = """
You are "AI Doctor Assistant" for Vietnamese doctors.
Reply briefly (1-2 sentences). Friendly Southern accent.
Format: "{Spoken text}" [ACTION: TAG]
Rules:
- Booking -> [ACTION: OPEN_CALENDAR]
- Prescription -> [ACTION: DRAFT_RX: drug_name]
- Payment -> [ACTION: TRIGGER_NFC]
- Security -> [ACTION: REQUIRE_2FA]
"""
model = genai.GenerativeModel("gemini-1.5-flash", system_instruction=SYSTEM_PROMPT)

# --- KHá»I Táº O SESSION ---
if "messages" not in st.session_state:
    st.session_state.messages = []
    st.session_state.chat_session = model.start_chat(history=[])

# --- GIAO DIá»†N CHÃNH ---
st.title("ğŸ¥ AI Doctor Assistant")
st.caption("Voice-First Interface Simulator")

# Hiá»ƒn thá»‹ lá»‹ch sá»­ chat
for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])
        if "action" in message and message["action"]:
             st.markdown(f"<div class='action-box'>ğŸ–¥ï¸ LINUX: {message['action']}</div>", unsafe_allow_html=True)

# --- INPUT Tá»ª ÄIá»†N THOáº I ---
# (DÃ¹ng Text Input Ä‘á»ƒ giáº£ láº­p giá»ng nÃ³i cho á»•n Ä‘á»‹nh trÃªn mobile web)
user_input = st.chat_input("BÃ¡c sÄ© nÃ³i gÃ¬ Ä‘i (hoáº·c nháº­p lá»‡nh)...")

if user_input:
    # 1. Hiá»ƒn thá»‹ tin nháº¯n ngÆ°á»i dÃ¹ng
    st.session_state.messages.append({"role": "user", "content": user_input})
    with st.chat_message("user"):
        st.markdown(user_input)

    # 2. Gá»­i Ä‘áº¿n AI
    response = st.session_state.chat_session.send_message(user_input)
    full_text = response.text

    # 3. TÃ¡ch Action vÃ  Lá»i nÃ³i
    action_match = re.search(r'\[ACTION:.*?\]', full_text)
    if action_match:
        action_tag = action_match.group(0)
        spoken_text = full_text.replace(action_tag, "").strip()
    else:
        action_tag = None
        spoken_text = full_text.strip()

    # 4. Hiá»ƒn thá»‹ pháº£n há»“i AI
    with st.chat_message("assistant"):
        st.markdown(spoken_text)
        if action_tag:
            st.markdown(f"<div class='action-box'>âš¡ SYSTEM EXECUTE: {action_tag}</div>", unsafe_allow_html=True)
            
            # MÃ´ phá»ng hiá»‡u á»©ng UI thay Ä‘á»•i
            if "OPEN_CALENDAR" in action_tag:
                st.info("ğŸ“… ÄÃ£ má»Ÿ á»©ng dá»¥ng Lá»‹ch (Calendar View)")
            elif "DRAFT_RX" in action_tag:
                st.warning("ğŸ’Š ÄÃ£ má»Ÿ Ä‘Æ¡n thuá»‘c nhÃ¡p (Prescription UI)")
            elif "TRIGGER_NFC" in action_tag:
                st.success("ğŸ’³ ÄÃ£ báº­t Ä‘áº§u Ä‘á»c tháº» NFC (Ready to Pay)")
            elif "REQUIRE_2FA" in action_tag:
                st.error("ğŸ”’ Cáº¢NH BÃO: YÃªu cáº§u xÃ¡c thá»±c vÃ¢n tay!")

    # 5. LÆ°u vÃ o lá»‹ch sá»­
    st.session_state.messages.append({"role": "assistant", "content": spoken_text, "action": action_tag})
    
    # 6. PhÃ¡t Ã¢m thanh (TTS)
    # LÆ°u Ã½: TrÃªn Mobile Web, autoplay audio bá»‹ háº¡n cháº¿ bá»Ÿi trÃ¬nh duyá»‡t, nÃªn ta hiá»‡n Audio Player
    tts = gTTS(spoken_text, lang='vi')
    tts.save("audio.mp3")
    st.audio("audio.mp3", format="audio/mp3", autoplay=True)