import os
import time
import sys
import re
import google.generativeai as genai
from colorama import Fore, Back, Style, init

# --- C·∫§U H√åNH (SETUP) ---
# THAY API KEY C·ª¶A B·∫†N V√ÄO D√íNG D∆Ø·ªöI ƒê√ÇY
API_KEY = "gen-lang-client-0939932636" 

if API_KEY == "YOUR_API_KEY_HERE":
    print(f"{Fore.RED}L·ªñI: B√°c ch∆∞a ƒëi·ªÅn Google API Key v√†o code!{Style.RESET_ALL}")
    sys.exit()

genai.configure(api_key=API_KEY)
init(autoreset=True)

# --- B·ªò N√ÉO AI (SYSTEM PROMPT) ---
SYSTEM_PROMPT = """
[ROLE]
You are the AI Voice Interface for a Medical AIO Linux System (Vietnamese Doctors in US).
Input: Voice Transcript (text).
Output Format: 
"{Vietnamese Spoken Response}"
[ACTION: TAG_NAME]

[RULES]
1. Be brief (1-2 sentences). 
2. Tone: Professional, Friendly, Southern Accent (D·∫°, Con, Th∆∞a).
3. SAFETY: If "Controlled Substances" (Oxy, Xanax, Opioids) -> [ACTION: TRIGGER_SECURITY_2FA].

[COMMANDS]
- Booking -> [ACTION: OPEN_CALENDAR]
- Prescription -> [ACTION: DRAFT_RX: {drug_name}]
- Payment -> [ACTION: TRIGGER_PAYMENT_NFC]
- Check Insurance -> [ACTION: CHECK_INSURANCE]
"""

model = genai.GenerativeModel("gemini-1.5-flash", system_instruction=SYSTEM_PROMPT)
chat_session = model.start_chat(history=[])

# --- GIAO DI·ªÜN GI·∫¢ L·∫¨P (MOCK UI) ---
def print_header():
    os.system('cls' if os.name == 'nt' else 'clear')
    print(f"{Back.GREEN}{Fore.BLACK} ========================================================= {Style.RESET_ALL}")
    print(f"{Back.GREEN}{Fore.BLACK}   üè• AI DOCTOR OFFICE ASSISTANT (LINUX AIO SIMULATOR)     {Style.RESET_ALL}")
    print(f"{Back.GREEN}{Fore.BLACK}   STATUS: ONLINE | VOICE: LISTENING | SYSTEM: READY       {Style.RESET_ALL}")
    print(f"{Back.GREEN}{Fore.BLACK} ========================================================= {Style.RESET_ALL}")
    print(f"\n{Fore.CYAN}[H∆Ø·ªöNG D·∫™N]: G√µ n·ªôi dung b√°c sƒ© mu·ªën n√≥i (V√≠ d·ª•: 'ƒê·∫∑t l·ªãch', 'K√™ ƒë∆°n')...")
    print("-" * 60)

def simulate_processing():
    """Hi·ªáu ·ª©ng AI ƒëang suy nghƒ©"""
    sys.stdout.write(f"{Fore.YELLOW}‚ö° AI Processing")
    for _ in range(3):
        time.sleep(0.3)
        sys.stdout.write(".")
        sys.stdout.flush()
    print(f"{Style.RESET_ALL}")

def execute_linux_action(tag):
    """M√¥ ph·ªèng vi·ªác th·ª±c thi l·ªánh xu·ªëng ph·∫ßn c·ª©ng Linux"""
    print(f"\n{Back.RED}{Fore.WHITE} >>> [LINUX KERNEL] EXECUTING ACTION... {Style.RESET_ALL}")
    time.sleep(0.5)
    
    if "OPEN_CALENDAR" in tag:
        print(f"{Fore.RED} üñ•Ô∏è  OPENING APP: GNOME-CALENDAR (Week View)")
        print(f"{Fore.RED} üìÖ  DISPLAY: Showing available slots for Dr. Hung.")
        
    elif "DRAFT_RX" in tag:
        drug = tag.split(":")[-1].replace("]", "").strip()
        print(f"{Fore.RED} üíä  API CALL: RxNorm Database -> Searching '{drug}'")
        print(f"{Fore.RED} üìù  UI: Displaying Prescription Draft on Touch Screen.")
        
    elif "TRIGGER_PAYMENT_NFC" in tag:
        print(f"{Fore.RED} üí≥  HARDWARE: Waking up NFC Reader (/dev/ttyUSB0)")
        print(f"{Fore.RED} üí≤  STATUS: Waiting for Patient's Card...")
        
    elif "TRIGGER_SECURITY_2FA" in tag:
        print(f"{Fore.RED} üîí  SECURITY ALERT: CONTROLLED SUBSTANCE DETECTED!")
        print(f"{Fore.RED} üîë  UI: Locking Screen. Requiring Fingerprint/FaceID.")
        
    elif "CHECK_INSURANCE" in tag:
        print(f"{Fore.RED} üè•  API CALL: Checking Eligibility (BlueCross BlueShield)...")
        print(f"{Fore.RED} ‚úÖ  RESULT: Approved. Co-pay: $20.00")
        
    else:
        print(f"{Fore.RED} ‚öôÔ∏è  SYSTEM LOG: Action logged ({tag})")
    print("-" * 60)

# --- V√íNG L·∫∂P CH√çNH (MAIN LOOP) ---
def main():
    print_header()
    
    while True:
        try:
            # 1. INPUT (Gi·∫£ l·∫≠p gi·ªçng n√≥i)
            user_input = input(f"\n{Fore.BLUE}üé§ DOCTOR (Voice): {Style.RESET_ALL}")
            
            if user_input.lower() in ["exit", "quit", "t·∫Øt m√°y"]:
                print(f"\n{Fore.MAGENTA}ü§ñ AI: D·∫°, ch√†o t·∫°m bi·ªát b√°c sƒ©.{Style.RESET_ALL}")
                break
            
            if not user_input.strip(): continue

            # 2. PROCESSING
            simulate_processing()
            response = chat_session.send_message(user_input)
            full_text = response.text

            # 3. PARSING & OUTPUT
            # T√°ch ph·∫ßn n√≥i v√† ph·∫ßn l·ªánh
            action_match = re.search(r'\[ACTION:.*?\]', full_text)
            
            if action_match:
                action_tag = action_match.group(0)
                spoken_text = full_text.replace(action_tag, "").strip()
            else:
                action_tag = None
                spoken_text = full_text.strip()

            # Hi·ªÉn th·ªã AI n√≥i
            print(f"{Fore.MAGENTA}ü§ñ AI (Speaker): {Style.BRIGHT}{spoken_text}{Style.RESET_ALL}")
            
            # Th·ª±c thi l·ªánh Linux
            if action_tag:
                execute_linux_action(action_tag)
                
        except Exception as e:
            print(f"{Fore.RED}Error: {e}{Style.RESET_ALL}")

if __name__ == "__main__":
    main()
